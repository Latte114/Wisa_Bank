<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wisa Bank</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js"></script>
  <style>
    /* Styles here */
  </style>
</head>
<body>
  <div id="entryGate">
    <h2>ใส่รหัสผ่านเพื่อเข้าสู่ระบบ</h2>
    <input type="password" id="entryPassword" placeholder="รหัสผ่าน" />
    <button id="entryBtn">ตกลง</button>
  </div>
  
  <div id="app" style="display: none;">
    <h2>Welcome to Wisa Bank</h2>
    <button id="loginBtn">เข้าสู่ระบบ</button>
    <button id="registerBtn">สร้างบัญชีใหม่</button>
  </div>
  
  <div id="schoolLogo">
    <img src="logo.png" alt="โลโก้โรงเรียนวิศานุสรณ์" />
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCKZBvt0isFRfqY1qujd9p-v0YkS5h0mIo",
      authDomain: "wisa-748f2.firebaseapp.com",
      databaseURL: "https://wisa-748f2-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "wisa-748f2",
      storageBucket: "wisa-748f2.firebasestorage.app",
      messagingSenderId: "460431433825",
      appId: "1:460431433825:web:6b22370e1869bf57200a20"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database(app);

    // ฟังก์ชันในการเข้าสู่ระบบ
    document.getElementById('entryBtn').addEventListener('click', function() {
      const pass = document.getElementById("entryPassword").value;
      if (pass === "Wisanusorn") {
        document.getElementById("entryGate").style.display = "none";
        document.getElementById("app").style.display = "block";
      } else {
        alert("รหัสผ่านไม่ถูกต้อง");
      }
    });

    // ฟังก์ชันเพื่อแสดงหน้าจอล็อกอิน
    document.getElementById('loginBtn').addEventListener('click', function() {
      showLogin();
    });

    // ฟังก์ชันเพื่อแสดงหน้าจอลงทะเบียน
    document.getElementById('registerBtn').addEventListener('click', function() {
      showRegister();
    });

    // ฟังก์ชันการลงทะเบียนบัญชีใหม่
    function showRegister() {
      const container = document.getElementById("app");
      container.innerHTML = `
        <h2>สร้างบัญชีใหม่</h2>
        <input type="text" id="registerId" placeholder="รหัสนักเรียน" />
        <button id="registerAccountBtn">สร้างบัญชี</button>
        <button onclick="backToMain()">ย้อนกลับ</button>
      `;
      
      document.getElementById('registerAccountBtn').addEventListener('click', function() {
        register();
      });
    }

    // ฟังก์ชันการล็อกอิน
    function showLogin() {
      const container = document.getElementById("app");
      container.innerHTML = `
        <h2>เข้าสู่ระบบ</h2>
        <input type="text" id="loginId" placeholder="รหัสนักเรียน / admin" />
        <button id="loginSubmitBtn">เข้าสู่ระบบ</button>
        <button onclick="backToMain()">ย้อนกลับ</button>
      `;
      
      document.getElementById('loginSubmitBtn').addEventListener('click', function() {
        login();
      });
    }

    // ฟังก์ชันลงทะเบียน
    function register() {
      const id = document.getElementById("registerId").value.trim();
      if (id) {
        const userRef = db.ref('accounts/' + id);
        userRef.set({
          balance: 0,
          history: []
        });
        alert("บัญชีถูกสร้างแล้ว");
        showLogin();
      } else {
        alert("กรุณากรอกรหัสนักเรียน");
      }
    }

    // ฟังก์ชันล็อกอิน
    function login() {
      const id = document.getElementById("loginId").value.trim();
      const userRef = db.ref('accounts/' + id);
      userRef.once('value', (snapshot) => {
        if (snapshot.exists()) {
          updateStudentView(id);
        } else {
          alert("ไม่พบรหัสนี้ในระบบ");
        }
      });
    }

    // ฟังก์ชันแสดงหน้าจอข้อมูลบัญชี
    function updateStudentView(id) {
      const container = document.getElementById("app");
      container.innerHTML = `
        <h2>บัญชี: ${id}</h2>
        <p>ยอดเงินคงเหลือ: <span id="balance">0</span> บาท</p>
        <input type="number" id="amount" placeholder="จำนวนเงิน" />
        <button id="depositBtn">ฝาก</button>
        <button id="withdrawBtn">ถอน</button>
        <button id="historyBtn">ดูประวัติ</button>
        <button onclick="logout()">ออกจากระบบ</button>
      `;
      
      document.getElementById('depositBtn').addEventListener('click', deposit);
      document.getElementById('withdrawBtn').addEventListener('click', withdraw);
      document.getElementById('historyBtn').addEventListener('click', showHistory);

      // Get balance
      userRef.once('value', (snapshot) => {
        const balance = snapshot.val().balance;
        document.getElementById("balance").textContent = balance;
      });
    }

    // ฟังก์ชันฝากเงิน
    function deposit() {
      const amount = parseFloat(document.getElementById("amount").value);
      if (amount > 0) {
        const userRef = db.ref('accounts/' + currentId);
        userRef.transaction((currentData) => {
          if (currentData) {
            currentData.balance += amount;
            currentData.history.push(`ฝาก ${amount} บาท`);
          }
          return currentData;
        });
      }
    }

    // ฟังก์ชันถอนเงิน
    function withdraw() {
      const amount = parseFloat(document.getElementById("amount").value);
      if (amount > 0) {
        const userRef = db.ref('accounts/' + currentId);
        userRef.transaction((currentData) => {
          if (currentData && currentData.balance >= amount) {
            currentData.balance -= amount;
            currentData.history.push(`ถอน ${amount} บาท`);
          }
          return currentData;
        });
      }
    }

    // ฟังก์ชันดูประวัติ
    function showHistory() {
      const userRef = db.ref('accounts/' + currentId);
      userRef.once('value', (snapshot) => {
        const history = snapshot.val().history;
        alert("ประวัติการทำรายการ: " + history.join("\n"));
      });
    }

    // ฟังก์ชันออกจากระบบ
    function logout() {
      currentId = null;
      showLogin();
    }

    // ฟังก์ชันย้อนกลับ
    function backToMain() {
      document.getElementById("app").innerHTML = `
        <h2>Welcome to Wisa Bank</h2>
        <button id="loginBtn">เข้าสู่ระบบ</button>
        <button id="registerBtn">สร้างบัญชีใหม่</button>
      `;
    }
  </script>
</body>
</html>
