<!DOCTYPE html>
<html lang="th">


<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wisa Bank</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit&display=swap" rel="stylesheet" />
  <link rel="icon" href="logo.png" type="image/png" sizes="32x32">
  <style>
    body {
      font-family: 'Kanit', sans-serif;
      background: #E6F3FF;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
    }


    #app,
    #historyPage,
    #entryGate {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 128, 255, 0.2);
      max-width: 400px;
      width: 100%;
    }


    input,
    button {
      width: 90%;
      padding: 10px;
      margin: 10px auto;
      font-size: 16px;
      display: block;
      border-radius: 8px;
      border: 1px solid #ccc;
    }


    button {
      background-color: #007BFF;
      color: white;
      border: none;
      cursor: pointer;
    }


    button:hover {
      background-color: #005ecb;
    }


    h2 {
      color: #007BFF;
      text-align: center;
    }


    #schoolLogo {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 999;
    }


    #schoolLogo img {
      width: 80px;
      height: auto;
    }


    #wisa-version-box {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background-color: rgba(240, 240, 240, 0.9);
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 0.75rem;
      color: #555;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      z-index: 999;
    }


    .user-card button {
      transition: background-color 0.2s;
    }
  </style>
  <script type="module">
    const WISA_VERSION = "v1.4.2"; // ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    document.getElementById("wisa-version").textContent = WISA_VERSION;
    window.WISA_VERSION = WISA_VERSION; // ‡πÉ‡∏´‡πâ HTML ‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô


    function exportHistoryToExcel(history, userName) {
      const wsData = [["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)"]];
      let total = 0;

      history.forEach((entry) => {
        if (typeof entry !== "string") return;  // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤ entry ‡πÄ‡∏õ‡πá‡∏ô string

        const match = entry.match(/(‡∏ù‡∏≤‡∏Å|‡∏ñ‡∏≠‡∏ô)\s([\d.]+)\s‡∏ö‡∏≤‡∏ó\s\((.+)\)/);
        if (match) {
          const type = match[1];
          const amount = parseFloat(match[2]);
          const date = match[3];
          const signedAmount = type === "‡∏ù‡∏≤‡∏Å" ? amount : -amount;
          total += signedAmount;
          wsData.push([date, type, signedAmount]);
        }
      });

      wsData.push(["", "‡∏£‡∏ß‡∏°", total]);

      const worksheet = XLSX.utils.aoa_to_sheet(wsData);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");

      // ‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå
      const safeFileName = `history_${userName.replace(/\s+/g, "_").replace(/[^\w\-‡∏Å-‡πô]/g, "")}.xlsx`;

      XLSX.writeFile(workbook, safeFileName);
    }
    window.exportHistoryToExcel = exportHistoryToExcel;

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getDatabase,
      ref,
      set,
      get,
      update,
      remove,
      onValue
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
    import * as XLSX from "https://cdn.sheetjs.com/xlsx-latest/package/xlsx.mjs";


    const firebaseConfig = {
      apiKey: "AIzaSyDy31hx7IoFqfvXZWeRwTtWjkq8BdmyEic",
      authDomain: "wisabank-6633b.firebaseapp.com",
      databaseURL: "https://wisabank-6633b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "wisabank-6633b",
      storageBucket: "wisabank-6633b.appspot.com",
      messagingSenderId: "239494442017",
      appId: "1:239494442017:web:7a9b4a0c3d2f8f8b392acd"
    };


    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);


    const $ = (id) => document.getElementById(id);
    let currentId = null;
    let currentName = "";


    window.checkEntryCode = () => {
      const pass = $("entryPassword").value;
      if (pass === "Wisanusorn") {
        $("entryGate").style.display = "none";
        $("app").style.display = "block";
        startApp();
      } else {
        alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
      }
    };


    window.startApp = () => {
      $("app").innerHTML = `
        <h2>Welcome to Wisa Bank</h2>
        <button onclick="showLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        <button onclick="showRegister()">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà</button>
      `;
    };


    window.showRegister = () => {
      $("app").innerHTML = `
        <h2>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà</h2>
        <input type="text" id="registerId" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" />
        <input type="text" id="registerName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" />
        <button onclick="register()">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</button>
        <button onclick="startApp()">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
      `;
    };


    window.register = async () => {
      const id = $("registerId").value.trim();
      const name = $("registerName").value.trim();
      if (!id || !name) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");


      const snap = await get(ref(db, `accounts/${id}`));
      if (snap.exists()) {
        alert("‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß");
      } else {
        await set(ref(db, `accounts/${id}`), {
          name,
          balance: 0,
          history: []
        });
        alert("‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
        showLogin();
      }
    };


    window.showLogin = () => {
      $("app").innerHTML = `
        <h2>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
        <input type="text" id="loginId" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô / admin" />
        <button onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        <button onclick="startApp()">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
      `;
    };


    window.login = async () => {
      const id = $("loginId").value.trim();
      if (id === "admin123") {
        updateAdminView();
        return;
      }
      const snap = await get(ref(db, `accounts/${id}`));
      if (!snap.exists()) {
        alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");
        return;
      }
      currentId = id;
      const data = snap.val();
      currentName = data.name;
      updateStudentView(id, data);
    };


    function updateStudentView(id, data) {
      $("app").innerHTML = `
        <h2>${data.name} (${id})</h2>
        <p>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${data.balance} ‡∏ö‡∏≤‡∏ó</p>
        <input type="number" id="amount" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô" />
        <button onclick="deposit()">‡∏ù‡∏≤‡∏Å</button>
        <button onclick="withdraw()">‡∏ñ‡∏≠‡∏ô</button>
        <button onclick="showStudentHistory()">‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
        <button onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
      `;
    }


    window.deposit = async () => {
      const amt = parseFloat($("amount").value);
      if (amt <= 0) return;


      const refPath = ref(db, `accounts/${currentId}`);
      const snap = await get(refPath);


      if (!snap.exists()) {
        alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ");
        return;
      }


      const data = snap.val();


      if (typeof data.balance !== "number") {
        data.balance = 0;
      }


      if (!Array.isArray(data.history)) {
        data.history = [];
      }


      data.balance += amt;
      data.history.unshift(`‡∏ù‡∏≤‡∏Å ${amt} ‡∏ö‡∏≤‡∏ó (${new Date().toLocaleDateString("th-TH")})`);


      await update(refPath, data);
      updateStudentView(currentId, data);
    };

    window.withdraw = async () => {
      const amt = parseFloat($("amount").value);
      const refPath = ref(db, `accounts/${currentId}`);
      const snap = await get(refPath);


      if (!snap.exists()) {
        alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ");
        return;
      }


      const data = snap.val();


      if (typeof data.balance !== "number") {
        data.balance = 0;
      }


      if (!Array.isArray(data.history)) {
        data.history = [];
      }


      if (amt <= 0 || amt > data.balance) {
        alert("‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
        return;
      }


      data.balance -= amt;
      data.history.unshift(`‡∏ñ‡∏≠‡∏ô ${amt} ‡∏ö‡∏≤‡∏ó (${new Date().toLocaleDateString("th-TH")})`);


      await update(refPath, data);
      updateStudentView(currentId, data);
    };

    window.logout = () => {
      currentId = null;
      currentName = "";
      startApp();
    };

    window.deleteAccount = async () => {
      if (confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ!")) {
        await remove(ref(db, `accounts/${currentId}`));
        alert("‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
        logout();
      }
    };

    window.updateAdminView = () => {
      const container = $("app");
      const allRef = ref(db, 'accounts');


      onValue(allRef, (snapshot) => {
        const data = snapshot.val();
        container.innerHTML = `<h2>‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h2>`;


        // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
        const dateSearchSection = document.createElement("div");
        dateSearchSection.style.marginBottom = "16px";


        const dateInput = document.createElement("input");
        dateInput.type = "date";
        dateInput.id = "searchDate";
        dateInput.style.marginRight = "8px";


        const searchBtn = document.createElement("button");
        searchBtn.textContent = "üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà";
        searchBtn.onclick = () => searchByDate(dateInput.value);


        dateSearchSection.appendChild(dateInput);
        dateSearchSection.appendChild(searchBtn);


        container.appendChild(dateSearchSection);


        // ‚úÖ ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        let totalBalance = 0;


        const sortedEntries = Object.entries(data).sort((a, b) =>
          Number(a[0]) - Number(b[0])
        );


        for (const [id, user] of sortedEntries) {
          totalBalance += typeof user.balance === "number" ? user.balance : 0;


          const userContainer = document.createElement("div");
          userContainer.className = "user-card";
          userContainer.style.marginBottom = "16px";
          userContainer.style.borderRadius = "12px";
          userContainer.style.overflow = "hidden";
          userContainer.style.boxShadow = "0 2px 8px rgba(0,0,0,0.1)";
          userContainer.style.backgroundColor = "#fff";
          userContainer.style.color = "black";
          userContainer.style.transition = "transform 0.2s ease-in-out";
          userContainer.onmouseover = () => (userContainer.style.transform = "translateY(-2px)");
          userContainer.onmouseout = () => (userContainer.style.transform = "translateY(0)");


          const header = document.createElement("div");
          header.style.display = "flex";
          header.style.justifyContent = "space-between";
          header.style.alignItems = "center";
          header.style.padding = "12px 16px";
          header.style.cursor = "pointer";
          header.style.backgroundColor = "#f8f9fa";
          header.style.color = "black";
          header.style.fontSize = "16px";
          header.style.fontWeight = "500";


          const nameElem = document.createElement("span");
          nameElem.innerHTML = `<strong style="color:black">${user.name}</strong> (${id})<br><small>üí∞ ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô: ${user.balance} ‡∏ö‡∏≤‡∏ó</small>`;


          const arrow = document.createElement("span");
          arrow.textContent = "‚ñº";
          arrow.style.transition = "transform 0.3s ease";
          arrow.style.fontSize = "18px";
          arrow.style.color = "#555";


          header.appendChild(nameElem);
          header.appendChild(arrow);


          const menu = document.createElement("div");
          menu.style.maxHeight = "0px";
          menu.style.overflow = "hidden";
          menu.style.transition = "max-height 0.3s ease-in-out, padding 0.3s";
          menu.style.padding = "0 16px";
          menu.style.backgroundColor = "#ffffff";


          const btns = [
            ["üìú ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥", () => showStudentHistory(id)],
            ["‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠", () => editUserName(id, user.name)],
            ["üÜî ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß", () => editUserId(id)],
            ["üóëÔ∏è ‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ", () => deleteAccount(id)],
          ];


          for (const [label, handler] of btns) {
            const btn = document.createElement("button");
            btn.textContent = label;
            btn.style.display = "block";
            btn.style.width = "100%";
            btn.style.textAlign = "left";
            btn.style.margin = "8px 0";
            btn.style.padding = "10px 14px";
            btn.style.background = "#f1f3f5";
            btn.style.border = "none";
            btn.style.borderRadius = "8px";
            btn.style.cursor = "pointer";
            btn.style.fontSize = "14px";
            btn.style.color = "#212529";
            btn.onmouseover = () => (btn.style.backgroundColor = "#e9ecef");
            btn.onmouseout = () => (btn.style.backgroundColor = "#f1f3f5");
            btn.onclick = handler;
            menu.appendChild(btn);
          }


          header.onclick = () => {
            const expanded = menu.style.maxHeight !== "0px";
            menu.style.maxHeight = expanded ? "0px" : "240px";
            menu.style.padding = expanded ? "0 16px" : "12px 16px";
            arrow.style.transform = expanded ? "rotate(0deg)" : "rotate(180deg)";
          };


          userContainer.appendChild(header);
          userContainer.appendChild(menu);
          container.appendChild(userContainer);
        }


        // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°
        const totalDiv = document.createElement("div");
        totalDiv.innerHTML = `<h3>üí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö: ${totalBalance} ‡∏ö‡∏≤‡∏ó</h3>`;
        totalDiv.style.marginTop = "20px";
        container.appendChild(totalDiv);


        const exportBtn = document.createElement("button");
        exportBtn.textContent = "üì§ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Excel)";
        exportBtn.onclick = exportAllAccountsToExcel;
        container.appendChild(exportBtn);


        const logoutBtn = document.createElement("button");
        logoutBtn.textContent = "‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö";
        logoutBtn.onclick = logout;
        container.appendChild(logoutBtn);
      });
    };


    window.exportAllAccountsToExcel = async () => {
      const snapshot = await get(ref(db, 'accounts'));
      const accounts = snapshot.val();


      if (!accounts) {
        alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ");
        return;
      }


      const rows = [["‡∏ä‡∏∑‡πà‡∏≠", "‡∏£‡∏´‡∏±‡∏™", "‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô"]];
      let total = 0;


      for (const id in accounts) {
        const user = accounts[id];
        rows.push([user.name, id, user.balance]);
        total += typeof user.balance === "number" ? user.balance : 0;
      }


      rows.push(["", "‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", total]);


      const worksheet = XLSX.utils.aoa_to_sheet(rows);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î");
      const safeName = typeof userName === "string" ? userName : "unknown_user";
      const safeFileName = `history_${safeName.replace(/\s+/g, "_").replace(/[^\w\-‡∏Å-‡πô]/g, "")}.xlsx`;

      XLSX.writeFile(workbook, "‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î.xlsx");
    };


    window.deleteAccount = async (id) => {
      if (confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
        await remove(ref(db, `accounts/${id}`));
        alert("‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
        updateAdminView();
      }
    };


    window.showStudentHistory = async (id) => {
      const studentId = id || currentId;
      const snap = await get(ref(db, `accounts/${studentId}`));
      if (!snap.exists()) return;
      const data = snap.val();

      $("app").style.display = "none";
      const historyDiv = $("historyPage");
      const historyList = $("historyList");
      historyList.innerHTML = "";

      const existingExport = document.getElementById("exportBtn");
      if (existingExport) existingExport.remove();

      // ‚úÖ ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
      const userName = data.name || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠";

      // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á‡∏ä‡∏∑‡πà‡∏≠
      const exportBtn = document.createElement("button");
      exportBtn.textContent = "‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (.xlsx)";
      exportBtn.id = "exportBtn";
      exportBtn.onclick = () => exportHistoryToExcel(data.history, userName);
      historyDiv.appendChild(exportBtn);

      if (!data.history || data.history.length === 0) {
        historyList.innerHTML = "<li>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</li>";
      } else {
        data.history.forEach(item => {
          const li = document.createElement("li");
          li.textContent = item;
          historyList.appendChild(li);
        });
      }

      historyDiv.style.display = "block";
    };


    window.backToMain = () => {
      $("historyPage").style.display = "none";
      $("app").style.display = "block";


      if (currentId === "admin123") {
        updateAdminView();
      } else if (currentId) {
        get(ref(db, `accounts/${currentId}`)).then((snap) => {
          if (snap.exists()) {
            updateStudentView(currentId, snap.val());
          } else {
            startApp();
          }
        });
      } else {
        startApp(); // fallback ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô error
      }
    };


    window.exportHistory = (historyArray, id) => {
      const content = historyArray.join("\n");
      const blob = new Blob([content], { type: "text/plain" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `history_${id}.txt`;
      link.click();
    };


    async function searchByDate(date) {
      if (!date) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤");
        return;
      }


      const container = $("app");
      container.innerHTML = `
    <h2>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${date}</h2>
    <button id="backBtn">‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</button>
    <div id="results" style="margin-top:16px;"></div>
    <h3 id="totalSum" style="margin-top:20px;"></h3>
  `;


      document.getElementById("backBtn").onclick = () => updateAdminView();


      const accountsSnap = await get(ref(db, 'accounts'));
      const accountsData = accountsSnap.val();


      const resultsDiv = document.getElementById("results");
      let totalFilteredBalance = 0;
      let foundCount = 0;


      // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô "1/6/2568" ‡∏´‡∏£‡∏∑‡∏≠ "01/06/2568" ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏°‡πà‡∏ô‡∏Å‡∏±‡∏ö format ‡πÉ‡∏ô history string
      // ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏°‡∏°‡∏ï‡∏¥‡πÉ‡∏ä‡πâ new Date().toLocaleDateString("th-TH") format dd/mm/yyyy (‡∏û.‡∏®.)
      // ‡∏î‡∏±‡∏á‡∏ô‡∏±‡πâ‡∏ô‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÅ‡∏õ‡∏•‡∏á date input ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô


      // ‡πÅ‡∏õ‡∏•‡∏á date ‡∏à‡∏≤‡∏Å input (yyyy-mm-dd) ‡πÄ‡∏õ‡πá‡∏ô dd/mm/yyyy (‡∏û.‡∏®.)
      function formatDateToThai(dateStr) {
        const parts = dateStr.split("-");
        const yearBuddhist = (parseInt(parts[0]) + 543).toString();
        return `${parseInt(parts[2])}/${parseInt(parts[1])}/${yearBuddhist}`;
      }


      const searchDateThai = formatDateToThai(date);


      for (const id in accountsData) {
        const user = accountsData[id];
        if (!user.history || !Array.isArray(user.history)) continue;


        user.history.forEach(entry => {
          // entry ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: "‡∏ù‡∏≤‡∏Å 100 ‡∏ö‡∏≤‡∏ó (1/6/2568)"
          if (entry.includes(`(${searchDateThai})`)) {
            foundCount++;
            const div = document.createElement("div");
            div.style.border = "1px solid #ccc";
            div.style.padding = "8px";
            div.style.marginBottom = "8px";
            div.style.borderRadius = "5px";
            div.style.backgroundColor = "#f9f9f9";


            div.innerHTML = `
          <strong>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: ${user.name} (${id})</strong><br>
          ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ${entry}
        `;
            resultsDiv.appendChild(div);


            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏à‡∏≤‡∏Å string entry
            const match = entry.match(/(‡∏ù‡∏≤‡∏Å|‡∏ñ‡∏≠‡∏ô)\s([\d.]+)\s‡∏ö‡∏≤‡∏ó/);
            if (match) {
              const type = match[1];
              const amount = parseFloat(match[2]);
              if (type === "‡∏ù‡∏≤‡∏Å") totalFilteredBalance += amount;
              else if (type === "‡∏ñ‡∏≠‡∏ô") totalFilteredBalance -= amount;
            }
          }
        });
      }


      if (foundCount === 0) {
        resultsDiv.innerHTML = "<i>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</i>";
      }


      const totalSum = document.getElementById("totalSum");
      totalSum.textContent = `‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ${totalFilteredBalance} ‡∏ö‡∏≤‡∏ó`;
    }
    window.editUserName = function (id, oldName) {
      const newName = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà:", oldName);
      if (newName && newName !== oldName) {
        update(ref(db, `users/${id}`), { name: newName })
          .then(() => {
            alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            updateAdminView();
          })
          .catch((error) => {
            console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:", error);
          });
      }
    };


    window.editUserId = function (oldId) {
      const newId = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏°‡πà:", oldId);
      if (newId && newId !== oldId) {
        get(child(dbRef, `users/${oldId}`)).then((snapshot) => {
          if (snapshot.exists()) {
            const userData = snapshot.val();
            set(ref(db, `users/${newId}`), userData).then(() => {
              remove(ref(db, `users/${oldId}`)).then(() => {
                alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                updateAdminView();
              });
            });
          }
        });
      }
    };




  </script>
</head>


<body>
  <div id="schoolLogo">
    <img src="logo.png" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡∏¥‡∏®‡∏≤‡∏ô‡∏∏‡∏™‡∏£‡∏ì‡πå" />
  </div>


  <div id="entryGate">
    <h2>‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
    <input type="password" id="entryPassword" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" />
    <button onclick="checkEntryCode()">‡∏ï‡∏Å‡∏•‡∏á</button>
  </div>


  <div id="app" style="display:none;"></div>


  <div id="historyPage" style="display:none;">
    <h2>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h2>
    <ul id="historyList" style="text-align:left;"></ul>
    <button onclick="backToMain()">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
  </div>


  <div id="dateSearchPage" style="display:none;">
    <h2>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</h2>
    <ul id="dateSearchResult"></ul>
    <button onclick="backToMain()">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
  </div>


  <div id="wisa-version-box">
    Wisa Bank Version <span id="wisa-version"></span>
  </div>


</body>


</html>
