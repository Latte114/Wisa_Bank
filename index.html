<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wisa Bank</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Kanit&display=swap"
      rel="stylesheet"
    />
    <link rel="icon" href="logo.png" type="image/png" sizes="32x32" />
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="dropdown.css" />
  </head>

  <body>
    <div id="schoolLogo" class="school-logo">
      <img src="logo.png" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡∏¥‡∏®‡∏≤‡∏ô‡∏∏‡∏™‡∏£‡∏ì‡πå" />
    </div>

    <header class="app-header">
      <h1>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡∏¥‡∏®‡∏≤‡∏ô‡∏∏‡∏™‡∏£‡∏ì‡πå</h1>
      <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡∏∞‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</p>
    </header>

    <div id="app" class="app-container"></div>

    <div
      id="historyPage"
      class="app-container history-page"
      style="display: none"
    >
      <h2>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h2>
      <ul id="historyList" class="history-list"></ul>
      <button class="button" onclick="window.backToMain()">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
    </div>

    <div
      id="studentHistoryPage"
      class="app-container student-history-page"
      style="display: none"
    >
      <h2>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: <span id="studentHistoryName"></span></h2>
      <ul id="studentHistoryList" class="history-list"></ul>
      <button class="button" onclick="window.backToAdminPage()">
        ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Admin
      </button>
    </div>

    <div
      id="dateSearchPage"
      class="app-container history-page"
      style="display: none"
    >
      <h2>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</h2>
      <div class="summary-box">
        <p>
          <strong>‡∏¢‡∏≠‡∏î‡∏ù‡∏≤‡∏Å‡∏£‡∏ß‡∏°:</strong>
          <span id="totalDepositAmount">0.00</span> ‡∏ö‡∏≤‡∏ó
        </p>
        <p>
          <strong>‡∏¢‡∏≠‡∏î‡∏ñ‡∏≠‡∏ô‡∏£‡∏ß‡∏°:</strong>
          <span id="totalWithdrawalAmount">0.00</span> ‡∏ö‡∏≤‡∏ó
        </p>
      </div>
      <ul id="dateSearchResult" class="history-list"></ul>
      <button class="button" onclick="window.backToMain()">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
    </div>

    <div
      id="transactionPage"
      class="app-container transaction-page"
      style="display: none"
    >
      <h2>‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)</h2>
      <p>
        ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: <strong id="transactionStudentName"></strong> (<span
          id="transactionStudentId"
        ></span
        >)
      </p>
      <p>
        ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <strong id="transactionStudentBalance"></strong> ‡∏ö‡∏≤‡∏ó
      </p>
      <div class="input-group">
        <label for="transactionAmount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô:</label>
        <input
          type="number"
          id="transactionAmount"
          placeholder="‡∏õ‡πâ‡∏≠‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô"
          class="input-field"
        />
      </div>
      <div class="button-group">
        <button
          class="button button--success"
          onclick="window.performDeposit()"
        >
          ‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô
        </button>
        <button
          class="button button--danger"
          onclick="window.performWithdraw()"
        >
          ‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô
        </button>
        <button class="button" onclick="window.backFromTransaction()">
          ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
        </button>
      </div>
      <p id="transactionMessage" class="message" style="display: none"></p>
    </div>

    <div
      id="adminHistoryPage"
      class="app-container admin-history-page"
      style="display: none"
    >
      <h2>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</h2>
      <div class="filter-controls flex-column align-center margin-bottom-md">
        <label for="adminFilterSelect" class="filter-label"
          >‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏° Admin ID:</label
        >
        <select id="adminFilterSelect" class="filter-select"></select>
        <label for="adminDateFilter" class="filter-label margin-top-sm"
          >‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label
        >
        <input type="date" id="adminDateFilter" class="filter-input" />
      </div>
      <ul id="adminHistoryList" class="admin-history-list"></ul>
      <button class="button" onclick="window.backToMainFromAdminHistory()">
        ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
      </button>
    </div>

    <div
      id="studentHistoryEditPage"
      class="app-container student-history-edit-page"
      style="display: none"
    >
      <h2>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h2>
      <p>
        ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: <strong id="historyEditStudentName"></strong> (<span
          id="historyEditStudentId"
        ></span
        >)
      </p>
      <textarea
        id="historyEditTextArea"
        placeholder="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î..."
      ></textarea>
      <button
        class="button button--success"
        onclick="window.saveStudentHistory()"
      >
        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
      </button>
      <button class="button" onclick="window.backFromStudentHistoryEdit()">
        ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
      </button>
    </div>

    <div id="wisa-version-box" class="wisa-version-box">
      Wisa Bank Version <span id="wisa-version"></span>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getDatabase,
        ref,
        set,
        get,
        update,
        remove,
        push,
        onValue,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
      import * as XLSX from "https://cdn.sheetjs.com/xlsx-latest/package/xlsx.mjs";

      const firebaseConfig = {
        apiKey: "AIzaSyDy31hx7IoFqfvXZWeRwTtWjkq8BdmyEic",
        authDomain: "wisabank-6633b.firebaseapp.com",
        databaseURL:
          "https://wisabank-6633b-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "wisabank-6633b",
        storageBucket: "wisabank-6633b.appspot.com",
        messagingSenderId: "239494442017",
        appId: "1:239494442017:web:7a9b4a0c3d2f8f8b392acd",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      const $ = (id) => document.getElementById(id);
      let currentId = null;
      let currentName = "";
      let currentStudentToManage = null;
      let currentTransactionStudentId = null; // Added for transaction page

      const WISA_VERSION = "v2.0.1";
      document.getElementById("wisa-version").textContent = WISA_VERSION;
      window.WISA_VERSION = WISA_VERSION;

      window.toggleDropdown = (id) => {
        document.getElementById(id).classList.toggle("show");
      };

      window.onclick = function (event) {
        if (!event.target.matches(".dropbtn")) {
          const dropdowns = document.getElementsByClassName("dropdown-content");
          for (let i = 0; i < dropdowns.length; i++) {
            const openDropdown = dropdowns[i];
            if (openDropdown.classList.contains("show")) {
              openDropdown.classList.remove("show");
            }
          }
        }
      };

      window.showAdminManagement = () => {
        const contentArea = document.getElementById("adminContentArea");
        if (contentArea) {
          contentArea.innerHTML =
            "<h3>‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Head Admin)</h3><p>‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏° ‡∏•‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>";
        } else {
          $("app").innerHTML = `
            <h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h2>
            <p>‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
            <button class="button" onclick="window.updateAdminView()">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        `;
        }
        window.toggleDropdown("adminDropdownContent");
      };

      function exportHistoryToExcel(history, userName) {
        // ... ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô exportHistoryToExcel
      }
      window.exportHistoryToExcel = exportHistoryToExcel;

      // ‡∏¢‡πâ‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô exportAllAccountsToExcel ‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
      window.exportAllAccountsToExcel = async () => {
        try {
          const snap = await get(ref(db, "accounts"));
          const accounts = snap.val() || {};
          const wsData = [
            [
              "‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô",
              "‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•",
              "‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏ö‡∏≤‡∏ó)",
              "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£",
            ],
          ];
          for (const id in accounts) {
            const account = accounts[id];
            const historyText = Array.isArray(account.history)
              ? account.history.join(" | ")
              : "";
            wsData.push([id, account.name, account.balance, historyText]);
          }
          const worksheet = XLSX.utils.aoa_to_sheet(wsData);
          const workbook = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(
            workbook,
            worksheet,
            "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"
          );
          const safeFileName = `all_accounts_${new Date()
            .toLocaleDateString("th-TH")
            .replace(/\//g, "-")}.xlsx`;
          XLSX.writeFile(workbook, safeFileName);
          alert("‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
          logAdminAction(
            "export_all_accounts",
            "‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏õ‡∏¢‡∏±‡∏á Excel"
          );
        } catch (error) {
          alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: " + error.message);
          console.error("Error exporting all accounts:", error);
        }
      };

      async function logAdminAction(actionType, details) {
        // ... ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô logAdminAction
      }

      window.onload = () => {
        window.showLogin();
      };

      window.showRegister = () => {
        $("app").innerHTML = `
        <h2>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà</h2>
        <div class="input-group">
          <label for="registerId">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</label>
          <input type="text" id="registerId" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" class="input-field"/>
        </div>
        <div class="input-group">
          <label for="registerName">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</label>
          <input type="text" id="registerName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" class="input-field"/>
        </div>
        <button class="button" onclick="window.register()">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</button>
      `;
      };

      window.register = async () => {
        const id = $("registerId").value.trim();
        const name = $("registerName").value.trim();
        if (!id || !name) {
          alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
          return;
        }

        try {
          const snap = await get(ref(db, `accounts/${id}`));
          if (snap.exists()) {
            alert("‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß");
            return;
          }

          const adminSnap = await get(ref(db, `admins/${id}`));
          if (
            adminSnap.exists() ||
            id === "admin123" ||
            id === "headadmin123"
          ) {
            alert(
              "‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô ID ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ID ‡∏≠‡∏∑‡πà‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ"
            );
            return;
          }

          await set(ref(db, `accounts/${id}`), {
            name,
            balance: 0,
            history: [],
          });
          alert("‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
          if (currentId) {
            logAdminAction("create_account", `‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: ${name} (ID: ${id})`);
          }
          if (currentId === "headadmin123") window.updateHeadAdminView();
          else window.updateAdminView();
        } catch (error) {
          alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: " + error.message);
          console.error("Error registering account:", error);
        }
      };

      window.showLogin = () => {
        $("app").innerHTML = `
        <div id="loginPage">
          <h2>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
          <div class="input-group">
            <label for="username">Username:</label>
            <input type="text" id="username" class="input-field" />
          </div>
          <div class="input-group">
            <label for="password">Password:</label>
            <input type="password" id="password" class="input-field" />
          </div>
          <div class="button-group">
            <button class="button" onclick="window.login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
          </div>
        </div>
      `;
      };

      window.login = async () => {
        const id = $("username").value.trim();
        const password = $("password").value.trim();

        if (!id || !password) {
          alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Username ‡πÅ‡∏•‡∏∞ Password");
          return;
        }

        try {
          const adminSnap = await get(ref(db, `admins/${id}`));

          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≤‡∏Å Firebase
          if (adminSnap.exists()) {
            const adminData = adminSnap.val();

            // ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô Firebase ‡πÅ‡∏•‡πâ‡∏ß)
            if (password === adminData.password) {
              currentId = id;
              currentName = adminData.name || "Admin"; // ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å Firebase ‡∏´‡∏£‡∏∑‡∏≠ "Admin" ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô

              // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏à‡∏≤‡∏Å Firebase
              const adminRole = adminData.role || "admin";

              // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
              if (adminRole === "headadmin") {
                window.updateHeadAdminView();
              } else {
                window.updateAdminView();
              }
              return;
            } else {
              alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
              return;
            }
          }
        } catch (error) {
          alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö: " + error.message);
          console.error("Error logging in:", error);
          return;
        }

        // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏û‡∏ö ID ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö admins
        alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô");
      };

      window.deposit = async (studentId, amountValue) => {
        const amt = parseFloat(amountValue);
        if (isNaN(amt) || amt <= 0) {
          alert("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0");
          return;
        }
        try {
          const refPath = ref(db, `accounts/${studentId}`);
          const snap = await get(refPath);
          if (!snap.exists()) {
            alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ");
            return;
          }
          const data = snap.val();
          data.balance = typeof data.balance !== "number" ? 0 : data.balance;
          data.history = !Array.isArray(data.history) ? [] : data.history;
          data.balance += amt;
          const adminWhoDeposited = currentName || currentId;
          const logEntry = `‡∏ù‡∏≤‡∏Å ${amt} ‡∏ö‡∏≤‡∏ó (‡πÇ‡∏î‡∏¢ ${adminWhoDeposited}) (${new Date().toLocaleDateString(
            "th-TH"
          )})`;
          data.history.unshift(logEntry);
          await update(refPath, data);
          alert(
            `‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô ${amt} ‡∏ö‡∏≤‡∏ó ‡πÉ‡∏´‡πâ ${data.name} (${studentId}) ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`
          );
          logAdminAction("deposit", {
            studentId: studentId,
            studentName: data.name,
            amount: amt,
          });
          // Instead of backFromTransaction directly, update the balance on the transaction page
          $("transactionStudentBalance").textContent = data.balance;
          $(
            "transactionMessage"
          ).textContent = `‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô ${amt} ‡∏ö‡∏≤‡∏ó ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${data.balance} ‡∏ö‡∏≤‡∏ó`;
          $("transactionMessage").className = "message success-message";
          $("transactionMessage").style.display = "block";
          $("transactionAmount").value = ""; // Clear amount field
        } catch (error) {
          alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô: " + error.message);
          console.error("Error depositing:", error);
          $(
            "transactionMessage"
          ).textContent = `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô: ${error.message}`;
          $("transactionMessage").className = "message error-message";
          $("transactionMessage").style.display = "block";
        }
      };

      // Add these two functions to make them globally accessible and call your existing logic
      window.performDeposit = async () => {
        const amount = parseFloat(
          document.getElementById("transactionAmount").value
        );
        if (isNaN(amount) || amount <= 0) {
          // You can replace this alert with your displayMessage function if you prefer
          alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡πâ‡∏≠‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
          return;
        }
        // Call your existing deposit logic
        await window.deposit(currentTransactionStudentId, amount);
      };

      window.performWithdraw = async () => {
        const amount = parseFloat(
          document.getElementById("transactionAmount").value
        );
        if (isNaN(amount) || amount <= 0) {
          // You can replace this alert with your displayMessage function if you prefer
          alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡πâ‡∏≠‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
          return;
        }
        // Call your existing adminWithdraw logic
        await window.adminWithdraw(currentTransactionStudentId, amount);
      };

      window.adminWithdraw = async (studentId, amountValue) => {
        const amt = parseFloat(amountValue);
        if (isNaN(amt) || amt <= 0) {
          alert("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0");
          return;
        }
        try {
          const refPath = ref(db, `accounts/${studentId}`);
          const snap = await get(refPath);
          if (!snap.exists()) {
            alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ");
            return;
          }
          const data = snap.val();
          data.balance = typeof data.balance !== "number" ? 0 : data.balance;
          data.history = !Array.isArray(data.history) ? [] : data.history;
          if (amt > data.balance) {
            alert(
              `‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô ${data.name} (${studentId}) ‡πÑ‡∏°‡πà‡∏û‡∏≠ (${data.balance} ‡∏ö‡∏≤‡∏ó)`
            );
            $(
              "transactionMessage"
            ).textContent = `‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô ${data.name} (${studentId}) ‡πÑ‡∏°‡πà‡∏û‡∏≠ (${data.balance} ‡∏ö‡∏≤‡∏ó)`;
            $("transactionMessage").className = "message error-message";
            $("transactionMessage").style.display = "block";
            return;
          }
          data.balance -= amt;
          const adminWhoWithdrew = currentName || currentId;
          const logEntry = `‡∏ñ‡∏≠‡∏ô ${amt} ‡∏ö‡∏≤‡∏ó (‡πÇ‡∏î‡∏¢ ${adminWhoWithdrew}) (${new Date().toLocaleDateString(
            "th-TH"
          )})`;
          data.history.unshift(logEntry);
          await update(refPath, data);
          alert(
            `‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ${amt} ‡∏ö‡∏≤‡∏ó ‡∏à‡∏≤‡∏Å ${data.name} (${studentId}) ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`
          );
          logAdminAction("withdraw", {
            studentId: studentId,
            studentName: data.name,
            amount: amt,
          });
          // Instead of backFromTransaction directly, update the balance on the transaction page
          $("transactionStudentBalance").textContent = data.balance;
          $(
            "transactionMessage"
          ).textContent = `‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ${amt} ‡∏ö‡∏≤‡∏ó ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${data.balance} ‡∏ö‡∏≤‡∏ó`;
          $("transactionMessage").className = "message success-message";
          $("transactionAmount").value = ""; // Clear amount field
        } catch (error) {
          alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô: " + error.message);
          console.error("Error withdrawing:", error);
          $(
            "transactionMessage"
          ).textContent = `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô: ${error.message}`;
          $("transactionMessage").className = "message error-message";
          $("transactionMessage").style.display = "block";
        }
      };

      window.logout = () => {
        currentId = null;
        currentName = "";
        currentStudentToManage = null;
        window.showLogin();
      };

      window.deleteAccount = async (idToDelete) => {
        if (
          confirm(
            "‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ!"
          )
        ) {
          try {
            const snap = await get(ref(db, `accounts/${idToDelete}`));
            let deletedAccountName = "Unknown";
            if (snap.exists()) {
              deletedAccountName = snap.val().name;
            }
            await remove(ref(db, `accounts/${idToDelete}`));
            alert("‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
            logAdminAction(
              "delete_account",
              `‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: ${deletedAccountName} (ID: ${idToDelete})`
            );

            if (currentId === "headadmin123") {
              window.updateHeadAdminView();
            } else if (currentId) {
              window.updateAdminView();
            } else {
              window.showLogin();
            }
          } catch (error) {
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: " + error.message);
            console.error("Error deleting account:", error);
          }
        }
      };

      window.updateHeadAdminView = () => {
        const container = $("app");
        container.innerHTML = ``;
        const allAccountsRef = ref(db, "accounts");

        if (!currentName || currentName === currentId) {
          currentName = "Head Admin";
        }

        container.innerHTML = `<h2>Head Admin - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö</h2>`;

        const primaryActions = document.createElement("div");
        primaryActions.className = "admin-section";
        primaryActions.innerHTML = `
        <h3>‚≠ê ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏Å</h3>
        <button class="button button--success margin-bottom-sm" onclick="window.showRegister()">‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà</button>
      `;
        container.appendChild(primaryActions);

        const adminManageSection = document.createElement("div");
        adminManageSection.className = "admin-section";
        adminManageSection.innerHTML = `
        <h3>üëë ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</h3>
        <button class="button button--success margin-bottom-sm" onclick="window.addAdmin()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
        <button class="button button--secondary" onclick="window.showAdminHistory()">üìú ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</button>
        <div id="adminList" class="admin-list-container"></div>
      `;
        container.appendChild(adminManageSection);
        displayAdminList();

        const studentManageSection = document.createElement("div");
        studentManageSection.className = "admin-section";
        studentManageSection.innerHTML = `<h3>üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>`;
        container.appendChild(studentManageSection);

        const dateSearchDiv = document.createElement("div");
        dateSearchDiv.className =
          "filter-controls flex-column align-center margin-bottom-md";
        const dateInput = document.createElement("input");
        dateInput.type = "date";
        dateInput.id = "searchDate";
        dateInput.className = "filter-input margin-bottom-sm";
        const searchBtn = document.createElement("button");
        searchBtn.textContent = "üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà";
        searchBtn.className = "button";
        searchBtn.onclick = () => window.searchByDate(dateInput.value);

        dateSearchDiv.appendChild(dateInput);
        dateSearchDiv.appendChild(searchBtn);
        studentManageSection.appendChild(dateSearchDiv);

        onValue(allAccountsRef, (snapshot) => {
          const data = snapshot.val() || {};
          let totalBalance = 0;
          const sortedEntries = Object.entries(data).sort((a, b) => {
            const idA = String(a[0]);
            const idB = String(b[0]);
            return idA.localeCompare(idB, undefined, { numeric: true });
          });

          const existingStudentCards = studentManageSection.querySelectorAll(
            ".user-card, .total-balance-summary"
          );
          existingStudentCards.forEach((card) => card.remove());

          for (const [id, user] of sortedEntries) {
            totalBalance += typeof user.balance === "number" ? user.balance : 0;

            const userContainer = document.createElement("div");
            userContainer.className = "user-card";

            const header = document.createElement("div");
            header.className = "user-card__header";
            header.onclick = () => {
              const expanded = menu.classList.toggle("is-expanded");
              arrow.style.transform = expanded
                ? "rotate(180deg)"
                : "rotate(0deg)";
            };

            const nameElem = document.createElement("span");
            nameElem.innerHTML = `<strong class="user-card__name">${user.name}</strong> (${id})<br><small class="user-card__balance">üí∞ ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô: ${user.balance} ‡∏ö‡∏≤‡∏ó</small>`;

            const arrow = document.createElement("span");
            arrow.className = "user-card__arrow";
            arrow.textContent = "‚ñº";

            header.appendChild(nameElem);
            header.appendChild(arrow);

            const menu = document.createElement("div");
            menu.className = "user-card__menu";

            const btns = [
              [
                "üìú ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥",
                () => window.showStudentHistory(id),
                "button",
                "",
              ],
              [
                "‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥",
                () => window.editStudentHistory(id),
                "button button--warning",
                "",
              ],
              [
                "üí∞ ‡∏ù‡∏≤‡∏Å/‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô",
                () => window.showTransactionPage(id),
                "button button--success",
                "",
              ],
              [
                "‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠",
                () => window.editUserName(id, user.name),
                "button button--purple",
                "",
              ],
              [
                "üÜî ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ID",
                () => window.editUserId(id),
                "button button--info",
                "",
              ],
              [
                "üóëÔ∏è ‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ",
                () => window.deleteAccount(id),
                "button button--danger",
                "",
              ],
            ];

            for (const [label, handler, className, textColor] of btns) {
              const btn = document.createElement("button");
              btn.textContent = label;
              btn.className = className;
              btn.style.color = textColor;
              btn.onclick = handler;
              menu.appendChild(btn);
            }

            userContainer.appendChild(header);
            userContainer.appendChild(menu);
            studentManageSection.appendChild(userContainer);
          }

          const totalDiv = document.createElement("div");
          totalDiv.innerHTML = `<h3 class="total-balance-summary">üí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö: ${totalBalance.toLocaleString()} ‡∏ö‡∏≤‡∏ó</h3>`;
          studentManageSection.appendChild(totalDiv);
        });

        const exportBtn = document.createElement("button");
        exportBtn.textContent = "üì§ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Excel)";
        exportBtn.className = "button";
        exportBtn.onclick = window.exportAllAccountsToExcel;
        container.appendChild(exportBtn);

        const logoutBtn = document.createElement("button");
        logoutBtn.textContent = "‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö";
        logoutBtn.className = "button button--danger";
        logoutBtn.onclick = window.logout;
        container.appendChild(logoutBtn);
      };

      async function displayAdminList() {
        const adminListDiv = $("adminList");
        adminListDiv.innerHTML = "";
        const adminsRef = ref(db, "admins");
        const snap = await get(adminsRef);
        const admins = snap.val();

        if (!admins || Object.keys(admins).length === 0) {
          adminListDiv.innerHTML +=
            '<p class="text-muted text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</p>';
          return;
        }

        const ul = document.createElement("ul");
        ul.className = "admin-list";

        for (const adminId in admins) {
          if (adminId === "admin123" || adminId === "headadmin123") continue;

          const adminName = admins[adminId].name;
          const li = document.createElement("li");
          li.className = "admin-list__item";

          const adminInfo = document.createElement("span");
          adminInfo.className = "admin-list__item-info";
          adminInfo.textContent = `${adminName} (ID: ${adminId})`;
          li.appendChild(adminInfo);

          const actionButtons = document.createElement("div");
          actionButtons.className = "admin-list__actions";
          const editPassBtn = document.createElement("button");
          editPassBtn.textContent = "‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡∏£‡∏´‡∏±‡∏™";
          editPassBtn.className = "button button--warning";
          editPassBtn.onclick = () =>
            window.editAdminPassword(adminId, adminName);
          actionButtons.appendChild(editPassBtn);

          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "üóëÔ∏è ‡∏•‡∏ö";
          deleteBtn.className = "button button--danger";
          deleteBtn.onclick = () => window.deleteAdminAccount(adminId);
          actionButtons.appendChild(deleteBtn);

          li.appendChild(actionButtons);
          ul.appendChild(li);
        }
        adminListDiv.appendChild(ul);
      }

      window.addAdmin = async () => {
        const newAdminId = prompt(
          "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å ID ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà (‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà):"
        );
        if (!newAdminId || newAdminId.trim() === "") {
          alert("ID ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á");
          return;
        }
        if (newAdminId === "admin123" || newAdminId === "headadmin123") {
          alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ ID ‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ID ‡∏≠‡∏∑‡πà‡∏ô");
          return;
        }
        const newAdminName = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà:");
        if (!newAdminName || newAdminName.trim() === "") {
          alert("‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á");
          return;
        }
        const newAdminPass = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà:");
        if (!newAdminPass || newAdminPass.trim() === "") {
          alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á");
          return;
        }
        try {
          const adminRef = ref(db, `admins/${newAdminId}`);
          const snap = await get(adminRef);
          if (snap.exists()) {
            alert("ID ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ID ‡∏≠‡∏∑‡πà‡∏ô");
          } else {
            const studentSnap = await get(ref(db, `accounts/${newAdminId}`));
            if (studentSnap.exists()) {
              alert(
                "ID ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ID ‡∏≠‡∏∑‡πà‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô"
              );
              return;
            }
            await set(adminRef, { name: newAdminName, password: newAdminPass });
            alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
            logAdminAction(
              "add_admin",
              `‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà: ${newAdminName} (ID: ${newAdminId})`
            );
            displayAdminList();
          }
        } catch (error) {
          alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô: " + error.message);
          console.error("Error adding admin:", error);
        }
      };

      window.editAdminPassword = async (adminId, adminName) => {
        const newPassword = prompt(
          `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô ${adminName} (ID: ${adminId}):`
        );
        if (newPassword === null) {
          return;
        }
        if (newPassword.trim() === "") {
          alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á");
          return;
        }
        try {
          await update(ref(db, `admins/${adminId}`), { password: newPassword });
          alert(
            `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô ${adminName} (ID: ${adminId}) ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`
          );
          logAdminAction(
            "edit_admin_password",
            `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô: ${adminName} (ID: ${adminId})`
          );
        } catch (error) {
          alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô: " + error.message);
          console.error("Error updating admin password:", error);
        }
      };

      window.deleteAdminAccount = async (adminIdToDelete) => {
        if (
          confirm(
            `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô ${adminIdToDelete} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ!`
          )
        ) {
          if (
            adminIdToDelete === "admin123" ||
            adminIdToDelete === "headadmin123"
          ) {
            alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏´‡∏£‡∏∑‡∏≠ Head Admin ‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ");
            return;
          }
          try {
            const snap = await get(ref(db, `admins/${adminIdToDelete}`));
            let deletedAdminName = "Unknown";
            if (snap.exists()) {
              deletedAdminName = snap.val().name;
            }
            await remove(ref(db, `admins/${adminIdToDelete}`));
            alert("‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
            logAdminAction(
              "delete_admin",
              `‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô: ${deletedAdminName} (ID: ${adminIdToDelete})`
            );
            displayAdminList();
          } catch (error) {
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô: " + error.message);
            console.error("Error deleting admin account:", error);
          }
        }
      };

      window.showAdminHistory = async () => {
        $("app").style.display = "none";
        $("adminHistoryPage").style.display = "block";
        const adminHistoryList = $("adminHistoryList");
        adminHistoryList.innerHTML = "";
        const adminLogsRef = ref(db, "admin_logs");
        const snapshot = await get(adminLogsRef);
        const logs = snapshot.val();
        const adminFilterSelect = $("adminFilterSelect");
        adminFilterSelect.innerHTML = '<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
        const uniqueAdmins = new Set();
        if (logs) {
          for (const key in logs) {
            uniqueAdmins.add(logs[key].adminId);
          }
        }
        Array.from(uniqueAdmins)
          .sort()
          .forEach((adminId) => {
            const option = document.createElement("option");
            option.value = adminId;
            option.textContent = adminId;
            adminFilterSelect.appendChild(option);
          });
        renderAdminLogs(logs);
        adminFilterSelect.onchange = () => renderAdminLogs(logs);
        $("adminDateFilter").onchange = () => renderAdminLogs(logs);
      };

      function renderAdminLogs(allLogs) {
        const adminHistoryList = $("adminHistoryList");
        adminHistoryList.innerHTML = "";
        const filterAdminId = $("adminFilterSelect").value;
        const filterDate = $("adminDateFilter").value;
        if (!allLogs) {
          adminHistoryList.innerHTML =
            "<li class='admin-history-item'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</li>";
          return;
        }
        const sortedLogs = Object.values(allLogs).sort((a, b) => {
          return new Date(b.timestamp) - new Date(a.timestamp);
        });
        let foundLogs = false;
        for (const log of sortedLogs) {
          if (filterAdminId && log.adminId !== filterAdminId) {
            continue;
          }
          if (filterDate) {
            const logDate = new Date(log.timestamp).toISOString().split("T")[0];
            if (logDate !== filterDate) {
              continue;
            }
          }
          foundLogs = true;
          const li = document.createElement("li");
          li.className = "admin-history-list__item";
          const date = new Date(log.timestamp).toLocaleString("th-TH", {
            year: "numeric",
            month: "numeric",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
            hour12: false,
          });
          li.innerHTML = `
            <strong>${date}</strong><br>
            <strong>Admin ID:</strong> ${log.adminId}<br>
            <strong>Action:</strong> ${log.actionType}<br>
            <strong>Details:</strong> ${
              typeof log.details === "object"
                ? JSON.stringify(log.details)
                : log.details
            }
          `;
          adminHistoryList.appendChild(li);
        }
        if (!foundLogs) {
          adminHistoryList.innerHTML =
            "<li class='admin-history-list__item'>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</li>";
        }
      }

      window.backToMainFromAdminHistory = () => {
        $("adminHistoryPage").style.display = "none";
        $("app").style.display = "block";
        if (currentId === "headadmin123") {
          window.updateHeadAdminView();
        } else {
          window.updateAdminView();
        }
      };

      window.updateAdminView = () => {
        const container = $("app");
        container.innerHTML = ``;
        const allAccountsRef = ref(db, "accounts");
        container.innerHTML = `<h2>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ${currentName}</h2>`;
        const primaryActions = document.createElement("div");
        primaryActions.className = "admin-section";
        primaryActions.innerHTML = `
          <h3>üí° ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô</h3>
          <button class="button button--success margin-bottom-sm" onclick="window.showRegister()">‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà</button>
        `;
        container.appendChild(primaryActions);

        const studentManageSection = document.createElement("div");
        studentManageSection.className = "admin-section";
        studentManageSection.innerHTML = `<h3>üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>`;
        container.appendChild(studentManageSection);

        const dateSearchDiv = document.createElement("div");
        dateSearchDiv.className =
          "filter-controls flex-column align-center margin-bottom-md";
        const dateInput = document.createElement("input");
        dateInput.type = "date";
        dateInput.id = "searchDate";
        dateInput.className = "filter-input margin-bottom-sm";
        const searchBtn = document.createElement("button");
        searchBtn.textContent = "üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà";
        searchBtn.className = "button";
        searchBtn.onclick = () => window.searchByDate(dateInput.value);

        dateSearchDiv.appendChild(dateInput);
        dateSearchDiv.appendChild(searchBtn);
        studentManageSection.appendChild(dateSearchDiv);

        onValue(allAccountsRef, (snapshot) => {
          const data = snapshot.val() || {};
          const sortedEntries = Object.entries(data).sort((a, b) => {
            const idA = String(a[0]);
            const idB = String(b[0]);
            return idA.localeCompare(idB, undefined, { numeric: true });
          });

          const existingStudentCards =
            studentManageSection.querySelectorAll(".user-card");
          existingStudentCards.forEach((card) => card.remove());

          for (const [id, user] of sortedEntries) {
            const userContainer = document.createElement("div");
            userContainer.className = "user-card";

            const header = document.createElement("div");
            header.className = "user-card__header";
            header.onclick = () => {
              const expanded = menu.classList.toggle("is-expanded");
              arrow.style.transform = expanded
                ? "rotate(180deg)"
                : "rotate(0deg)";
            };

            const nameElem = document.createElement("span");
            nameElem.innerHTML = `<strong class="user-card__name">${user.name}</strong> (${id})<br><small class="user-card__balance">üí∞ ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô: ${user.balance} ‡∏ö‡∏≤‡∏ó</small>`;

            const arrow = document.createElement("span");
            arrow.className = "user-card__arrow";
            arrow.textContent = "‚ñº";

            header.appendChild(nameElem);
            header.appendChild(arrow);

            const menu = document.createElement("div");
            menu.className = "user-card__menu";

            const btns = [
              [
                "üìú ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥",
                () => window.showStudentHistory(id),
                "button",
                "",
              ],
              [
                "üí∞ ‡∏ù‡∏≤‡∏Å/‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô",
                () => window.showTransactionPage(id),
                "button button--success",
                "",
              ],
            ];

            for (const [label, handler, className, textColor] of btns) {
              const btn = document.createElement("button");
              btn.textContent = label;
              btn.className = className;
              btn.style.color = textColor;
              btn.onclick = handler;
              menu.appendChild(btn);
            }

            userContainer.appendChild(header);
            userContainer.appendChild(menu);
            studentManageSection.appendChild(userContainer);
          }
        });

        const logoutBtn = document.createElement("button");
        logoutBtn.textContent = "‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö";
        logoutBtn.className = "button button--danger";
        logoutBtn.onclick = window.logout;
        container.appendChild(logoutBtn);
      };

      // Helper function to format date from YYYY-MM-DD to DD/MM/YYYY
      function formatDateForComparison(dateString) {
        if (!dateString) return "";
        const [year, month, day] = dateString.split("-");
        // Add 543 to the year for Thai Buddhist Era (B.E.)
        return `${parseInt(day, 10)}/${parseInt(month, 10)}/${
          parseInt(year, 10) + 543
        }`;
      }

      // Function to search all student transactions by date
      window.searchByDate = async (dateString) => {
        const searchDateFormatted = formatDateForComparison(dateString);
        if (!searchDateFormatted) {
          alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤");
          return;
        }

        $("app").style.display = "none";
        $("dateSearchPage").style.display = "block";
        const dateSearchResultList = $("dateSearchResult");
        dateSearchResultList.innerHTML = ""; // Clear previous results

        // Get elements for displaying sums and initialize them to 0.00
        const totalDepositElement = $("totalDepositAmount");
        const totalWithdrawalElement = $("totalWithdrawalAmount");
        totalDepositElement.textContent = "0.00";
        totalWithdrawalElement.textContent = "0.00";

        let totalDeposit = 0;
        let totalWithdrawal = 0;
        let foundResults = false;

        try {
          const accountsSnapshot = await get(ref(db, "accounts"));
          const allAccounts = accountsSnapshot.val() || {};

          for (const studentId in allAccounts) {
            const studentData = allAccounts[studentId];
            const history = studentData.history || [];

            history.forEach((entry) => {
              // Extract date from history entry, assuming format like "... (DD/MM/YYYY)"
              const dateMatch = entry.match(/\((\d{1,2}\/\d{1,2}\/\d{4})\)/);
              if (dateMatch && dateMatch[1] === searchDateFormatted) {
                foundResults = true;
                const listItem = document.createElement("li");
                listItem.className = "search-results__item account-item"; // Reuse existing styles

                // Extract amount and type (deposit/withdrawal)
                // This regex looks for "‡∏ù‡∏≤‡∏Å" or "‡∏ñ‡∏≠‡∏ô" followed by space, then numbers (with optional commas/dots) and "‡∏ö‡∏≤‡∏ó"
                const amountMatch = entry.match(/(‡∏ù‡∏≤‡∏Å|‡∏ñ‡∏≠‡∏ô)\s+([\d,.]+)\s+‡∏ö‡∏≤‡∏ó/);
                if (amountMatch) {
                  const type = amountMatch[1]; // "‡∏ù‡∏≤‡∏Å" or "‡∏ñ‡∏≠‡∏ô"
                  // Remove commas before parsing to float to ensure correct number conversion
                  const amount = parseFloat(amountMatch[2].replace(/,/g, ""));

                  if (type === "‡∏ù‡∏≤‡∏Å") {
                    totalDeposit += amount;
                  } else if (type === "‡∏ñ‡∏≠‡∏ô") {
                    totalWithdrawal += amount;
                  }
                }

                listItem.innerHTML = `
                  <div class="account-name">${studentData.name} (ID: ${studentId})</div>
                  <div class="account-id">${entry}</div>
                `;
                dateSearchResultList.appendChild(listItem);
              }
            });
          }

          // Update the display for total sums after processing all accounts
          // Use toLocaleString for proper number formatting with 2 decimal places
          totalDepositElement.textContent = totalDeposit.toLocaleString(
            "th-TH",
            { minimumFractionDigits: 2, maximumFractionDigits: 2 }
          );
          totalWithdrawalElement.textContent = totalWithdrawal.toLocaleString(
            "th-TH",
            { minimumFractionDigits: 2, maximumFractionDigits: 2 }
          );

          if (!foundResults) {
            dateSearchResultList.innerHTML =
              '<p class="text-muted text-center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ</p>';
          }
        } catch (error) {
          alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: " + error.message);
          console.error("Error searching by date:", error);
        }
      };

      // Function to show the transaction page
      window.showTransactionPage = async (studentId) => {
        currentTransactionStudentId = studentId; // Store the student ID
        $("app").style.display = "none";
        $("transactionPage").style.display = "block";
        $("transactionMessage").style.display = "none"; // Hide message initially

        try {
          const snap = await get(ref(db, `accounts/${studentId}`));
          if (snap.exists()) {
            const studentData = snap.val();
            $("transactionStudentName").textContent = studentData.name;
            $("transactionStudentId").textContent = studentId;
            $("transactionStudentBalance").textContent =
              studentData.balance.toLocaleString("th-TH", {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2,
              });
          } else {
            alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô");
            window.backFromTransaction();
          }
        } catch (error) {
          alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: " + error.message);
          console.error("Error fetching student data for transaction:", error);
          window.backFromTransaction();
        }
      };

      window.backFromTransaction = () => {
        $("transactionPage").style.display = "none";
        $("app").style.display = "block";
        $("transactionAmount").value = ""; // Clear amount
        $("transactionMessage").style.display = "none"; // Hide message
        if (currentId === "headadmin123") {
          window.updateHeadAdminView();
        } else {
          window.updateAdminView();
        }
      };

      window.showStudentHistory = async (studentId) => {
        currentStudentToManage = studentId;
        $("app").style.display = "none";
        $("studentHistoryPage").style.display = "block";
        const historyList = $("studentHistoryList");
        historyList.innerHTML = "";
        try {
          const snap = await get(ref(db, `accounts/${studentId}`));
          if (snap.exists()) {
            const data = snap.val();
            $("studentHistoryName").textContent = data.name;
            if (data.history && data.history.length > 0) {
              data.history.forEach((entry) => {
                const li = document.createElement("li");
                li.textContent = entry;
                historyList.appendChild(li);
              });
            } else {
              historyList.innerHTML =
                "<li class='text-muted'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</li>";
            }
          } else {
            historyList.innerHTML =
              "<li class='text-muted'>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</li>";
          }
        } catch (error) {
          alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥: " + error.message);
          console.error("Error fetching student history:", error);
        }
      };

      window.backToAdminPage = () => {
        $("studentHistoryPage").style.display = "none";
        $("app").style.display = "block";
        if (currentId === "headadmin123") {
          window.updateHeadAdminView();
        } else {
          window.updateAdminView();
        }
      };

      window.backToMain = () => {
        $("historyPage").style.display = "none";
        $("dateSearchPage").style.display = "none";
        $("app").style.display = "block";
        if (currentId === "headadmin123") {
          window.updateHeadAdminView();
        } else {
          window.updateAdminView();
        }
      };

      window.editStudentHistory = async (studentId) => {
        currentStudentToManage = studentId;
        $("app").style.display = "none";
        $("studentHistoryEditPage").style.display = "block";
        $("historyEditTextArea").value = ""; // Clear previous content
        try {
          const snap = await get(ref(db, `accounts/${studentId}`));
          if (snap.exists()) {
            const data = snap.val();
            $("historyEditStudentName").textContent = data.name;
            $("historyEditStudentId").textContent = studentId;
            if (Array.isArray(data.history) && data.history.length > 0) {
              $("historyEditTextArea").value = data.history.join("\n");
            } else {
              $("historyEditTextArea").value = "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£";
            }
          } else {
            alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô");
            window.backFromStudentHistoryEdit();
          }
        } catch (error) {
          alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: " + error.message);
          console.error("Error fetching history for edit:", error);
        }
      };

      window.saveStudentHistory = async () => {
        const studentId = currentStudentToManage;
        const newHistoryText = $("historyEditTextArea").value;
        let newHistoryArray = [];
        if (
          newHistoryText &&
          newHistoryText.trim() !== "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£"
        ) {
          newHistoryArray = newHistoryText
            .split("\n")
            .map((line) => line.trim())
            .filter((line) => line !== "");
        }

        try {
          await update(ref(db, `accounts/${studentId}`), {
            history: newHistoryArray,
          });
          alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
          logAdminAction("edit_student_history", {
            studentId: studentId,
            oldHistory: "‡πÇ‡∏õ‡∏£‡∏î‡∏î‡∏π‡∏à‡∏≤‡∏Å log ‡πÄ‡∏Å‡πà‡∏≤", // Can't store full old history here easily without another fetch
            newHistory: newHistoryArray.join(" | "),
          });
          window.backFromStudentHistoryEdit();
        } catch (error) {
          alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥: " + error.message);
          console.error("Error saving student history:", error);
        }
      };

      window.backFromStudentHistoryEdit = () => {
        $("studentHistoryEditPage").style.display = "none";
        $("app").style.display = "block";
        if (currentId === "headadmin123") {
          window.updateHeadAdminView();
        } else {
          window.updateAdminView();
        }
      };

      window.editUserName = async (studentId, currentStudentName) => {
        const newName = prompt(
          `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${currentStudentName} (ID: ${studentId}):`,
          currentStudentName
        );
        if (newName === null || newName.trim() === "") {
          alert("‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ");
          return;
        }

        try {
          await update(ref(db, `accounts/${studentId}`), { name: newName });
          alert(
            `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏Ç‡∏≠‡∏á ${currentStudentName} (ID: ${studentId}) ‡πÄ‡∏õ‡πá‡∏ô ${newName} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`
          );
          logAdminAction("edit_user_name", {
            studentId: studentId,
            oldName: currentStudentName,
            newName: newName,
          });
          if (currentId === "headadmin123") {
            window.updateHeadAdminView();
          } else {
            window.updateAdminView();
          }
        } catch (error) {
          alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•: " + error.message);
          console.error("Error editing user name:", error);
        }
      };

      window.editUserId = async (oldStudentId) => {
        const newStudentId = prompt(
          `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å ID ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${oldStudentId}: (‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ)`,
          oldStudentId
        );

        if (
          newStudentId === null ||
          newStudentId.trim() === "" ||
          newStudentId === oldStudentId
        ) {
          alert("ID ‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö ID ‡πÄ‡∏î‡∏¥‡∏°");
          return;
        }

        // Check if new ID already exists in accounts or admins
        try {
          const newAccountSnap = await get(ref(db, `accounts/${newStudentId}`));
          if (newAccountSnap.exists()) {
            alert("ID ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ID ‡∏≠‡∏∑‡πà‡∏ô");
            return;
          }
          const newAdminSnap = await get(ref(db, `admins/${newStudentId}`));
          if (newAdminSnap.exists()) {
            alert(
              "ID ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ID ‡∏≠‡∏∑‡πà‡∏ô"
            );
            return;
          }
        } catch (error) {
          console.error("Error checking new ID existence:", error);
          alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ID ‡πÉ‡∏´‡∏°‡πà: " + error.message);
          return;
        }

        if (
          !confirm(
            `‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ID ‡∏à‡∏≤‡∏Å ${oldStudentId} ‡πÄ‡∏õ‡πá‡∏ô ${newStudentId} ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ!`
          )
        ) {
          return;
        }

        try {
          const oldAccountRef = ref(db, `accounts/${oldStudentId}`);
          const oldAccountSnap = await get(oldAccountRef);

          if (!oldAccountSnap.exists()) {
            alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏Å‡πà‡∏≤");
            return;
          }

          const accountData = oldAccountSnap.val();

          // 1. Create new account with new ID
          await set(ref(db, `accounts/${newStudentId}`), accountData);

          // 2. Delete old account
          await remove(oldAccountRef);

          alert(
            `‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ID ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏à‡∏≤‡∏Å ${oldStudentId} ‡πÄ‡∏õ‡πá‡∏ô ${newStudentId} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`
          );
          logAdminAction("edit_user_id", {
            oldId: oldStudentId,
            newId: newStudentId,
            studentName: accountData.name,
          });

          if (currentId === "headadmin123") {
            window.updateHeadAdminView();
          } else {
            window.updateAdminView();
          }
        } catch (error) {
          alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ID: " + error.message);
          console.error("Error editing user ID:", error);
        }
      };

      // Ensure the filterAdminLogs is called when the date or admin selection changes
      document.addEventListener("DOMContentLoaded", () => {
        const adminFilterSelect = $("adminFilterSelect");
        const adminDateFilter = $("adminDateFilter");
        if (adminFilterSelect) {
          adminFilterSelect.addEventListener("change", window.filterAdminLogs);
        }
        if (adminDateFilter) {
          adminDateFilter.addEventListener("change", window.filterAdminLogs);
        }
      });
    </script>
  </body>
</html>
